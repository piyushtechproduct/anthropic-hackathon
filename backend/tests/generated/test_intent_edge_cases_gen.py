"""
Category: Backend API â€” Intent Edge Cases
What it tests: Edge-case handling in the /api/intent endpoint, including empty
    prompts, very long inputs, special characters (emoji, unicode, HTML),
    markdown-fenced Claude responses, extra whitespace, missing required fields,
    all filter types at once, and completely invalid JSON from the LLM.
How tests work: Each test mocks the Anthropic client so no real API calls are
    made. The FastAPI app is exercised via httpx AsyncClient with ASGITransport.
Test count: 8
Generated by: QA Agent (qa-gen skill)
"""

import json
from unittest.mock import MagicMock, patch

import pytest
from httpx import ASGITransport, AsyncClient

from src.app.main import app


@pytest.mark.asyncio
async def test_intent_empty_prompt():
    """Empty prompt should be accepted (FastAPI doesn't validate str length)."""
    mock_response = {
        "raw_query": "",
        "search_url": "https://www.amazon.in/s?k=",
        "filters": [],
    }
    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps(mock_response))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/intent",
                json={"prompt": ""},
            )

    assert response.status_code == 200


@pytest.mark.asyncio
async def test_intent_very_long_prompt():
    """Very long prompt (1000+ chars) should still work."""
    long_prompt = "white nike tshirt " * 100

    mock_response = {
        "raw_query": "white nike tshirt",
        "search_url": "https://www.amazon.in/s?k=white+nike+tshirt",
        "filters": [{"type": "brand", "value": "Nike"}],
    }
    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps(mock_response))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/intent",
                json={"prompt": long_prompt},
            )

    assert response.status_code == 200
    data = response.json()
    assert "raw_query" in data
    assert "search_url" in data


@pytest.mark.asyncio
async def test_intent_special_characters():
    """Prompt with emoji, unicode, and HTML tags should be handled."""
    special_prompt = "white nike tshirt \U0001f455 <b>bold</b> cafe \u20b9500"

    mock_response = {
        "raw_query": "white nike tshirt",
        "search_url": "https://www.amazon.in/s?k=white+nike+tshirt",
        "filters": [
            {"type": "brand", "value": "Nike"},
            {"type": "price", "value": "Under \u20b9500"},
            {"type": "color", "value": "White"},
        ],
    }
    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps(mock_response))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/intent",
                json={"prompt": special_prompt},
            )

    assert response.status_code == 200
    data = response.json()
    assert "raw_query" in data


@pytest.mark.asyncio
async def test_intent_markdown_fences_stripped():
    """Claude response wrapped in markdown fences should be stripped and parsed."""
    inner_json = {
        "raw_query": "samsung phone",
        "search_url": "https://www.amazon.in/s?k=samsung+phone",
        "filters": [{"type": "brand", "value": "Samsung"}],
    }
    fenced_response = f"```json\n{json.dumps(inner_json)}\n```"

    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=fenced_response)]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/intent",
                json={"prompt": "samsung phone"},
            )

    assert response.status_code == 200
    data = response.json()
    assert data["raw_query"] == "samsung phone"
    assert data["filters"][0]["type"] == "brand"


@pytest.mark.asyncio
async def test_intent_response_with_extra_whitespace():
    """Claude response with extra whitespace should parse correctly."""
    inner_json = {
        "raw_query": "shoes",
        "search_url": "https://www.amazon.in/s?k=shoes",
        "filters": [],
    }
    response_text = f"  \n\n  {json.dumps(inner_json, indent=2)}  \n\n  "

    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=response_text)]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/intent",
                json={"prompt": "shoes"},
            )

    assert response.status_code == 200
    assert response.json()["raw_query"] == "shoes"


@pytest.mark.asyncio
async def test_intent_missing_required_fields_returns_500():
    """Claude response missing required fields should return 500."""
    mock_message = MagicMock()
    mock_message.content = [MagicMock(text='{"raw_query": "test"}')]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/intent",
                json={"prompt": "test"},
            )

    assert response.status_code == 500


@pytest.mark.asyncio
async def test_intent_all_filter_types():
    """Response with all filter types should be parsed correctly."""
    mock_response = {
        "raw_query": "white nike xl tshirt",
        "search_url": "https://www.amazon.in/s?k=white+nike+xl+tshirt",
        "filters": [
            {"type": "brand", "value": "Nike"},
            {"type": "price", "value": "Under \u20b91,000"},
            {"type": "delivery", "value": "Prime"},
            {"type": "rating", "value": "4\u2605 & up"},
            {"type": "color", "value": "White"},
            {"type": "size", "value": "XL"},
            {"type": "discount", "value": "10% off or more"},
        ],
    }
    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps(mock_response))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/intent",
                json={"prompt": "white nike xl tshirt under 1000 prime 4 star deals"},
            )

    assert response.status_code == 200
    data = response.json()
    filter_types = {f["type"] for f in data["filters"]}
    assert filter_types == {
        "brand",
        "price",
        "delivery",
        "rating",
        "color",
        "size",
        "discount",
    }


@pytest.mark.asyncio
async def test_intent_invalid_json_from_claude():
    """Claude returning invalid JSON should result in 500."""
    mock_message = MagicMock()
    mock_message.content = [MagicMock(text="This is not valid JSON at all")]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/intent",
                json={"prompt": "test"},
            )

    assert response.status_code == 500
