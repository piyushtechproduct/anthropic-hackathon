"""
Category: Performance
What it tests: Latency and throughput characteristics of the API — health
    endpoint response time (<100 ms), 10 concurrent intent requests, ranking
    with 50 and 100 products, 10 sequential rapid-fire requests, response
    payload sizes for intent (<10 KB) and rank (<50 KB), 10 concurrent
    multi-platform intent requests, and average health-check overhead over
    100 iterations.
How tests work: Each test mocks the Anthropic client so no real API calls are
    made. Wall-clock timing is measured with time.perf_counter and asserted
    against upper-bound thresholds.
Test count: 9
Generated by: QA Agent (qa-gen skill)
"""

import asyncio
import json
import time
from unittest.mock import MagicMock, patch

import pytest
from httpx import ASGITransport, AsyncClient

from src.app.main import app

MOCK_INTENT_RESPONSE = {
    "raw_query": "white nike tshirt",
    "search_url": "https://www.amazon.in/s?k=white+nike+tshirt",
    "filters": [
        {"type": "brand", "value": "Nike"},
        {"type": "price", "value": "Under ₹500"},
    ],
}

MOCK_MULTI_RESPONSE = {
    "raw_query": "white nike tshirt",
    "platforms": [
        {
            "platform": "amazon",
            "search_url": "https://www.amazon.in/s?k=white+nike+tshirt",
            "filters": [{"type": "brand", "value": "Nike"}],
        },
        {
            "platform": "flipkart",
            "search_url": "https://www.flipkart.com/search?q=white+nike+tshirt",
            "filters": [{"type": "brand", "value": "Nike"}],
        },
    ],
}


@pytest.mark.asyncio
async def test_health_endpoint_responds_under_100ms():
    """Health endpoint should respond in under 100ms."""
    async with AsyncClient(
        transport=ASGITransport(app=app), base_url="http://test"
    ) as client:
        start = time.perf_counter()
        response = await client.get("/health")
        elapsed_ms = (time.perf_counter() - start) * 1000

    assert response.status_code == 200
    assert elapsed_ms < 100, (
        f"Health endpoint took {elapsed_ms:.2f}ms, expected < 100ms"
    )


@pytest.mark.asyncio
async def test_concurrent_intent_requests():
    """Test 10 simultaneous intent requests with mocked LLM."""
    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps(MOCK_INTENT_RESPONSE))]

    async def make_request(client: AsyncClient, idx: int):
        response = await client.post(
            "/api/intent",
            json={"prompt": f"test query {idx}"},
        )
        return response.status_code, idx

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            start = time.perf_counter()
            results = await asyncio.gather(
                *[make_request(client, i) for i in range(10)]
            )
            elapsed = time.perf_counter() - start

    # All requests should succeed
    assert all(status == 200 for status, _ in results)
    assert len(results) == 10
    # Concurrent execution should be faster than sequential
    assert elapsed < 5.0, f"10 concurrent requests took {elapsed:.2f}s"


@pytest.mark.asyncio
async def test_large_payload_rank_50_products():
    """Test rank endpoint with 50 products."""
    products = [
        {
            "title": f"Product {i}",
            "price": 100.0 + i * 10,
            "rating": 3.5 + (i % 5) * 0.2,
            "review_count": 50 + i * 5,
            "image_url": f"https://example.com/img{i}.jpg",
            "product_url": f"https://example.com/product{i}",
            "platform": "amazon" if i % 2 == 0 else "flipkart",
        }
        for i in range(50)
    ]

    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps({"indices": [0, 5, 10, 15, 20]}))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            start = time.perf_counter()
            response = await client.post(
                "/api/rank",
                json={"query": "best products", "products": products},
            )
            elapsed_ms = (time.perf_counter() - start) * 1000

    assert response.status_code == 200
    data = response.json()
    assert len(data["ranked_products"]) == 5
    assert elapsed_ms < 5000, f"50 products took {elapsed_ms:.2f}ms"


@pytest.mark.asyncio
async def test_rank_100_products_within_timeout():
    """Test rank endpoint with 100 products returns within reasonable timeout."""
    products = [
        {
            "title": f"Product {i}",
            "price": 100.0 + i * 10,
            "rating": 3.0 + (i % 10) * 0.15,
            "review_count": 10 + i * 3,
            "image_url": f"https://example.com/img{i}.jpg",
            "product_url": f"https://example.com/product{i}",
            "platform": "amazon" if i % 3 == 0 else "flipkart",
        }
        for i in range(100)
    ]

    mock_message = MagicMock()
    mock_message.content = [
        MagicMock(text=json.dumps({"indices": [10, 25, 50, 75, 90]}))
    ]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test", timeout=10.0
        ) as client:
            start = time.perf_counter()
            response = await client.post(
                "/api/rank",
                json={"query": "best value products", "products": products},
            )
            elapsed_ms = (time.perf_counter() - start) * 1000

    assert response.status_code == 200
    data = response.json()
    assert len(data["ranked_products"]) == 5
    assert elapsed_ms < 10000, f"100 products took {elapsed_ms:.2f}ms, expected < 10s"


@pytest.mark.asyncio
async def test_sequential_rapid_requests_all_succeed():
    """Test 10 back-to-back sequential requests all succeed."""
    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps(MOCK_INTENT_RESPONSE))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            start = time.perf_counter()
            results = []
            for i in range(10):
                response = await client.post(
                    "/api/intent",
                    json={"prompt": f"query {i}"},
                )
                results.append(response.status_code)
            elapsed = time.perf_counter() - start

    assert all(status == 200 for status in results)
    assert len(results) == 10
    assert elapsed < 10.0, f"10 sequential requests took {elapsed:.2f}s"


@pytest.mark.asyncio
async def test_response_size_is_reasonable_for_intent():
    """Intent endpoint response size should be under 10KB."""
    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps(MOCK_INTENT_RESPONSE))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/intent",
                json={"prompt": "white nike tshirt under 500"},
            )

    assert response.status_code == 200
    response_size_bytes = len(response.content)
    response_size_kb = response_size_bytes / 1024
    assert response_size_kb < 10, (
        f"Response size {response_size_kb:.2f}KB exceeds 10KB limit"
    )


@pytest.mark.asyncio
async def test_response_size_is_reasonable_for_rank():
    """Rank endpoint response with 50 products should be under 50KB."""
    products = [
        {
            "title": f"Product {i} with a long description to test payload size",
            "price": 100.0 + i * 10,
            "rating": 4.0,
            "review_count": 100,
            "image_url": f"https://example.com/images/product_{i}.jpg",
            "product_url": f"https://example.com/products/detail/{i}",
            "platform": "amazon",
        }
        for i in range(50)
    ]

    mock_message = MagicMock()
    mock_message.content = [
        MagicMock(text=json.dumps({"indices": [0, 10, 20, 30, 40]}))
    ]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/rank",
                json={"query": "test query", "products": products},
            )

    assert response.status_code == 200
    response_size_bytes = len(response.content)
    response_size_kb = response_size_bytes / 1024
    assert response_size_kb < 50, (
        f"Response size {response_size_kb:.2f}KB exceeds 50KB limit"
    )


@pytest.mark.asyncio
async def test_multi_platform_intent_under_concurrent_load():
    """Test multi-platform intent endpoint handles 10 concurrent requests."""
    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps(MOCK_MULTI_RESPONSE))]

    async def make_multi_request(client: AsyncClient, idx: int):
        response = await client.post(
            "/api/intent/multi",
            json={"prompt": f"test query {idx}"},
        )
        return response.status_code, response.json()

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            start = time.perf_counter()
            results = await asyncio.gather(
                *[make_multi_request(client, i) for i in range(10)]
            )
            elapsed = time.perf_counter() - start

    # All requests should succeed
    assert all(status == 200 for status, _ in results)
    # All should have both platforms
    for _, data in results:
        assert "platforms" in data
        assert len(data["platforms"]) == 2
    assert elapsed < 5.0, f"10 concurrent multi-platform requests took {elapsed:.2f}s"


@pytest.mark.asyncio
async def test_health_endpoint_minimal_overhead():
    """Test health endpoint has minimal overhead by measuring 100 requests."""
    async with AsyncClient(
        transport=ASGITransport(app=app), base_url="http://test"
    ) as client:
        start = time.perf_counter()
        for _ in range(100):
            response = await client.get("/health")
            assert response.status_code == 200
        elapsed_ms = (time.perf_counter() - start) * 1000

    avg_time_ms = elapsed_ms / 100
    assert avg_time_ms < 10, f"Average health check time {avg_time_ms:.2f}ms too high"
