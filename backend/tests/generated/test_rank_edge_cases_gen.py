"""
Category: Backend API — Rank Edge Cases
What it tests: Edge-case handling in the /api/rank endpoint and the
    rank_products service function, including fewer-than-five products,
    exactly five products, zero prices, null ratings/review counts, very large
    review counts, invalid/out-of-range LLM indices, malformed JSON from the
    LLM, the deterministic scoring fallback formula, and empty product lists.
How tests work: Each test mocks the Anthropic client so no real API calls are
    made. Tests exercise both the HTTP endpoint (via httpx AsyncClient) and the
    rank_products function directly.
Test count: 11
Generated by: QA Agent (qa-gen skill)
"""

import json
from unittest.mock import MagicMock, patch

import pytest
from httpx import ASGITransport, AsyncClient

from src.app.main import app
from src.app.models import Product
from src.app.services import rank_products


@pytest.mark.asyncio
async def test_rank_fewer_than_five_products():
    """Fewer than 5 products should return all without LLM call."""
    products = [
        {
            "title": "Product 1",
            "price": 100.0,
            "rating": 4.5,
            "review_count": 100,
            "image_url": "https://example.com/img1.jpg",
            "product_url": "https://example.com/product1",
            "platform": "amazon",
        },
        {
            "title": "Product 2",
            "price": 200.0,
            "rating": 4.0,
            "review_count": 50,
            "image_url": "https://example.com/img2.jpg",
            "product_url": "https://example.com/product2",
            "platform": "flipkart",
        },
        {
            "title": "Product 3",
            "price": 150.0,
            "rating": 4.2,
            "review_count": 75,
            "image_url": "https://example.com/img3.jpg",
            "product_url": "https://example.com/product3",
            "platform": "amazon",
        },
    ]

    async with AsyncClient(
        transport=ASGITransport(app=app), base_url="http://test"
    ) as client:
        response = await client.post(
            "/api/rank",
            json={"query": "laptop", "products": products},
        )

    assert response.status_code == 200
    data = response.json()
    assert len(data["ranked_products"]) == 3
    # Should return all products without modification
    returned_titles = {p["title"] for p in data["ranked_products"]}
    assert returned_titles == {"Product 1", "Product 2", "Product 3"}


@pytest.mark.asyncio
async def test_rank_exactly_five_products():
    """Exactly 5 products should return all without LLM call."""
    products = [
        {
            "title": f"Product {i}",
            "price": 100.0 + i * 50,
            "rating": 4.0 + i * 0.1,
            "review_count": 100 + i * 20,
            "image_url": f"https://example.com/img{i}.jpg",
            "product_url": f"https://example.com/product{i}",
            "platform": "amazon" if i % 2 == 0 else "flipkart",
        }
        for i in range(5)
    ]

    async with AsyncClient(
        transport=ASGITransport(app=app), base_url="http://test"
    ) as client:
        response = await client.post(
            "/api/rank",
            json={"query": "phone", "products": products},
        )

    assert response.status_code == 200
    data = response.json()
    assert len(data["ranked_products"]) == 5


@pytest.mark.asyncio
async def test_rank_products_with_zero_price():
    """Products with zero price should be handled in scoring."""
    products = [
        {
            "title": f"Product {i}",
            "price": 0.0 if i == 0 else 100.0 + i * 50,
            "rating": 4.5,
            "review_count": 100,
            "image_url": f"https://example.com/img{i}.jpg",
            "product_url": f"https://example.com/product{i}",
            "platform": "amazon",
        }
        for i in range(8)
    ]

    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps({"indices": [1, 2, 3, 4, 5]}))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/rank",
                json={"query": "shoes", "products": products},
            )

    assert response.status_code == 200
    data = response.json()
    assert len(data["ranked_products"]) == 5


def test_rank_products_with_null_ratings():
    """Products with null ratings should be handled gracefully."""
    products = [
        Product(
            title=f"Product {i}",
            price=100.0 + i * 50,
            rating=None if i % 2 == 0 else 4.5,
            review_count=100,
            image_url=f"https://example.com/img{i}.jpg",
            product_url=f"https://example.com/product{i}",
            platform="amazon",
        )
        for i in range(10)
    ]

    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps({"indices": [0, 2, 4, 6, 8]}))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        result = rank_products("laptop", products)

    assert len(result) == 5
    # Verify all products have titles
    for p in result:
        assert p.title


def test_rank_llm_returns_invalid_indices():
    """LLM returning invalid indices should fall back to deterministic sort."""
    products = [
        Product(
            title=f"Product {i}",
            price=100.0 + i * 50,
            rating=4.0 + i * 0.1,
            review_count=100 + i * 20,
            image_url=f"https://example.com/img{i}.jpg",
            product_url=f"https://example.com/product{i}",
            platform="amazon",
        )
        for i in range(10)
    ]

    mock_message = MagicMock()
    # Return out-of-bounds and negative indices
    mock_message.content = [MagicMock(text=json.dumps({"indices": [99, -5, 100]}))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        result = rank_products("headphones", products)

    # Should fall back and return 5 products
    assert len(result) == 5
    # All should be valid Product objects
    for p in result:
        assert p.title
        assert p.price > 0


def test_rank_llm_returns_fewer_than_three_valid_indices():
    """LLM returning fewer than 3 valid indices should trigger fallback."""
    products = [
        Product(
            title=f"Product {i}",
            price=100.0 + i * 50,
            rating=4.0,
            review_count=100,
            image_url=f"https://example.com/img{i}.jpg",
            product_url=f"https://example.com/product{i}",
            platform="amazon",
        )
        for i in range(10)
    ]

    mock_message = MagicMock()
    # Return only 2 valid indices
    mock_message.content = [MagicMock(text=json.dumps({"indices": [0, 1]}))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        result = rank_products("tablet", products)

    # Should fall back to deterministic sort and return 5
    assert len(result) == 5


@pytest.mark.asyncio
async def test_rank_empty_product_list():
    """Empty product list should return empty ranked list."""
    async with AsyncClient(
        transport=ASGITransport(app=app), base_url="http://test"
    ) as client:
        response = await client.post(
            "/api/rank",
            json={"query": "camera", "products": []},
        )

    assert response.status_code == 200
    data = response.json()
    assert len(data["ranked_products"]) == 0


def test_rank_products_with_very_large_review_counts():
    """Products with very large review counts should be scored correctly."""
    products = [
        Product(
            title=f"Product {i}",
            price=100.0 + i * 10,
            rating=4.5,
            review_count=100000 if i == 0 else 100 + i * 20,
            image_url=f"https://example.com/img{i}.jpg",
            product_url=f"https://example.com/product{i}",
            platform="amazon",
        )
        for i in range(10)
    ]

    mock_message = MagicMock()
    mock_message.content = [MagicMock(text=json.dumps({"indices": [0, 1, 2, 3, 4]}))]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        result = rank_products("watch", products)

    assert len(result) == 5
    # Verify the product with 100000 reviews is included
    review_counts = [p.review_count for p in result]
    assert any(rc == 100000 for rc in review_counts)


def test_rank_deterministic_score_calculation():
    """Test the deterministic scoring formula: (rating * log(reviews + 1)) / price.

    Need > 5 products so rank_products doesn't return early.
    """
    products = [
        Product(
            title="Balanced",
            price=50.0,
            rating=4.0,
            review_count=500,
            image_url="https://example.com/img1.jpg",
            product_url="https://example.com/product1",
            platform="amazon",
        ),
        Product(
            title="Cheap low quality",
            price=30.0,
            rating=2.0,
            review_count=5,
            image_url="https://example.com/img2.jpg",
            product_url="https://example.com/product2",
            platform="flipkart",
        ),
        Product(
            title="Expensive premium",
            price=500.0,
            rating=4.8,
            review_count=2000,
            image_url="https://example.com/img3.jpg",
            product_url="https://example.com/product3",
            platform="amazon",
        ),
        Product(
            title="Mid tier",
            price=100.0,
            rating=3.5,
            review_count=300,
            image_url="https://example.com/img4.jpg",
            product_url="https://example.com/product4",
            platform="flipkart",
        ),
        Product(
            title="Budget pick",
            price=200.0,
            rating=2.5,
            review_count=20,
            image_url="https://example.com/img5.jpg",
            product_url="https://example.com/product5",
            platform="amazon",
        ),
        Product(
            title="Filler",
            price=200.0,
            rating=3.0,
            review_count=10,
            image_url="https://example.com/img6.jpg",
            product_url="https://example.com/product6",
            platform="flipkart",
        ),
    ]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_anthropic.side_effect = Exception("Force fallback")
        result = rank_products("product", products)

    assert len(result) == 5
    # Balanced has best score: (4.0 * log(501)) / 50 ≈ 0.497
    assert result[0].title == "Balanced"


@pytest.mark.asyncio
async def test_rank_llm_returns_malformed_json():
    """LLM returning malformed JSON should trigger fallback."""
    products = [
        {
            "title": f"Product {i}",
            "price": 100.0 + i * 50,
            "rating": 4.0,
            "review_count": 100,
            "image_url": f"https://example.com/img{i}.jpg",
            "product_url": f"https://example.com/product{i}",
            "platform": "amazon",
        }
        for i in range(10)
    ]

    mock_message = MagicMock()
    mock_message.content = [MagicMock(text="invalid json {{{")]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_client = MagicMock()
        mock_client.messages.create.return_value = mock_message
        mock_anthropic.return_value = mock_client

        async with AsyncClient(
            transport=ASGITransport(app=app), base_url="http://test"
        ) as client:
            response = await client.post(
                "/api/rank",
                json={"query": "mouse", "products": products},
            )

    assert response.status_code == 200
    data = response.json()
    assert len(data["ranked_products"]) == 5


def test_rank_products_with_null_review_counts():
    """Products with null review counts should be handled gracefully."""
    products = [
        Product(
            title=f"Product {i}",
            price=100.0 + i * 50,
            rating=4.5,
            review_count=None if i % 3 == 0 else 100 + i * 20,
            image_url=f"https://example.com/img{i}.jpg",
            product_url=f"https://example.com/product{i}",
            platform="amazon",
        )
        for i in range(10)
    ]

    with patch("src.app.services.anthropic.Anthropic") as mock_anthropic:
        mock_anthropic.side_effect = Exception("Force fallback")
        result = rank_products("keyboard", products)

    assert len(result) == 5
    # Verify products with null review counts are included
    for p in result:
        assert p.title
