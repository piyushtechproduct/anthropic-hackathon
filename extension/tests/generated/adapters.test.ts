/**
 * Category: Extension — Adapter Utilities
 * What it tests: Unit tests for the shared adapter utility functions used by
 *     the Amazon and Flipkart adapters — extractPriceNumber, formatIndianNumber,
 *     parsePriceText, parseReviewCount, matchPrice, and getSectionIdForFilter.
 *     Covers normal values, edge cases (empty strings, nulls, large numbers,
 *     Indian-style formatting), and boundary conditions.
 * How tests work: Pure function tests — no mocking or network calls required.
 *     Each describe block targets one utility function.
 * Test count: 50
 * Generated by: QA Agent (qa-gen skill)
 */

import { describe, it, expect } from "vitest";
import {
  extractPriceNumber,
  formatIndianNumber,
  parsePriceText,
  parseReviewCount,
  matchPrice,
  getSectionIdForFilter,
} from "../../src/adapters/utils";

describe("extractPriceNumber", () => {
  it("should extract price from 'Under ₹500' format", () => {
    expect(extractPriceNumber("Under ₹500")).toBe(500);
  });

  it("should extract price from formatted amount '₹1,500'", () => {
    expect(extractPriceNumber("₹1,500")).toBe(1500);
  });

  it("should extract price from 'Under ₹15,000' format", () => {
    expect(extractPriceNumber("Under ₹15,000")).toBe(15000);
  });

  it("should return null for text with no price", () => {
    expect(extractPriceNumber("no price")).toBeNull();
  });

  it("should return null for empty string", () => {
    expect(extractPriceNumber("")).toBeNull();
  });

  it("should extract first number from complex strings", () => {
    expect(extractPriceNumber("Price range ₹2,500 to ₹5,000")).toBe(2500);
  });

  it("should handle price without commas", () => {
    expect(extractPriceNumber("₹999")).toBe(999);
  });
});

describe("formatIndianNumber", () => {
  it("should format small number without commas", () => {
    expect(formatIndianNumber(500)).toBe("500");
  });

  it("should format four-digit number with comma", () => {
    expect(formatIndianNumber(1500)).toBe("1,500");
  });

  it("should format six-digit number in Indian style", () => {
    expect(formatIndianNumber(150000)).toBe("1,50,000");
  });

  it("should format seven-digit number in Indian style", () => {
    expect(formatIndianNumber(1500000)).toBe("15,00,000");
  });

  it("should format zero correctly", () => {
    expect(formatIndianNumber(0)).toBe("0");
  });

  it("should format three-digit number correctly", () => {
    expect(formatIndianNumber(999)).toBe("999");
  });

  it("should format five-digit number correctly", () => {
    expect(formatIndianNumber(12345)).toBe("12,345");
  });

  it("should format eight-digit number in Indian style", () => {
    expect(formatIndianNumber(12345678)).toBe("1,23,45,678");
  });
});

describe("parsePriceText", () => {
  it("should parse formatted price '₹1,499'", () => {
    expect(parsePriceText("₹1,499")).toBe(1499);
  });

  it("should parse price with spaces '₹ 2,999'", () => {
    expect(parsePriceText("₹ 2,999")).toBe(2999);
  });

  it("should return 0 for non-numeric text", () => {
    expect(parsePriceText("abc")).toBe(0);
  });

  it("should return 0 for empty string", () => {
    expect(parsePriceText("")).toBe(0);
  });

  it("should parse price without rupee symbol", () => {
    expect(parsePriceText("5,999")).toBe(5999);
  });

  it("should parse decimal prices correctly", () => {
    expect(parsePriceText("₹1,499.50")).toBe(1499.5);
  });

  it("should handle price with multiple spaces", () => {
    expect(parsePriceText("₹  3,  500")).toBe(3500);
  });

  it("should parse large formatted prices", () => {
    expect(parsePriceText("₹12,34,567")).toBe(1234567);
  });
});

describe("parseReviewCount", () => {
  it("should parse formatted review count '1,234'", () => {
    expect(parseReviewCount("1,234")).toBe(1234);
  });

  it("should parse simple review count '50'", () => {
    expect(parseReviewCount("50")).toBe(50);
  });

  it("should return null for empty string", () => {
    expect(parseReviewCount("")).toBeNull();
  });

  it("should handle review count with spaces", () => {
    expect(parseReviewCount("5 678")).toBe(5678);
  });

  it("should parse large review counts", () => {
    expect(parseReviewCount("1,23,456")).toBe(123456);
  });

  it("should extract first number from text with reviews", () => {
    expect(parseReviewCount("Based on 999 customer reviews")).toBe(999);
  });

  it("should return null for text without numbers", () => {
    expect(parseReviewCount("No reviews")).toBeNull();
  });
});

describe("matchPrice", () => {
  it("should match 'up to' format with 'under' filter", () => {
    expect(matchPrice("up to ₹500", "under ₹500")).toBe(true);
  });

  it("should match 'up to' format with 'under' filter for larger amount", () => {
    expect(matchPrice("up to ₹1,500", "under ₹1500")).toBe(true);
  });

  it("should match price range format", () => {
    expect(matchPrice("₹500 - ₹1,000", "₹500-₹1000")).toBe(true);
  });

  it("should not match unrelated text", () => {
    expect(matchPrice("random text", "under ₹500")).toBe(false);
  });

  it("should match range upper bound with 'under' filter", () => {
    expect(matchPrice("₹0 - ₹500", "under ₹500")).toBe(true);
  });

  it("should not match if price numbers differ", () => {
    expect(matchPrice("up to ₹1,000", "under ₹500")).toBe(false);
  });

  it("should match formatted price with commas", () => {
    expect(matchPrice("up to ₹1,500", "under ₹1,500")).toBe(true);
  });

  it("should match price range with spaces", () => {
    expect(matchPrice("₹ 1,000 - ₹ 2,000", "₹1000-₹2000")).toBe(true);
  });

  it("should return false for invalid filter value", () => {
    expect(matchPrice("up to ₹500", "invalid price")).toBe(false);
  });

  it("should handle range without rupee symbols in filter", () => {
    expect(matchPrice("₹500 - ₹1,000", "500-1000")).toBe(true);
  });
});

describe("getSectionIdForFilter", () => {
  it("should return correct section ID for brand filter", () => {
    expect(getSectionIdForFilter("brand")).toBe("brandsRefinements");
  });

  it("should return correct section ID for price filter", () => {
    expect(getSectionIdForFilter("price")).toBe("priceRefinements");
  });

  it("should return null for unknown filter type", () => {
    expect(getSectionIdForFilter("unknown")).toBeNull();
  });

  it("should return correct section ID for delivery filter", () => {
    expect(getSectionIdForFilter("delivery")).toBe("deliveryRefinements");
  });

  it("should return correct section ID for rating filter", () => {
    expect(getSectionIdForFilter("rating")).toBe("reviewsRefinements");
  });

  it("should return correct section ID for size filter", () => {
    expect(getSectionIdForFilter("size")).toBe("sizeRefinements");
  });

  it("should return correct section ID for color filter", () => {
    expect(getSectionIdForFilter("color")).toBe("size_two_browse");
  });

  it("should return correct section ID for colour filter (UK spelling)", () => {
    expect(getSectionIdForFilter("colour")).toBe("size_two_browse");
  });

  it("should return correct section ID for discount filter", () => {
    expect(getSectionIdForFilter("discount")).toBe("pct-off");
  });

  it("should handle case-insensitive filter types", () => {
    expect(getSectionIdForFilter("BRAND")).toBe("brandsRefinements");
    expect(getSectionIdForFilter("Price")).toBe("priceRefinements");
  });
});
